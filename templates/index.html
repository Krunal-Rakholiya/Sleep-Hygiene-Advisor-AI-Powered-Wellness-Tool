<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sleep Hygiene Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .chat-container {
            max-width: 500px;
            margin: 40px auto;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            padding: 2rem 1.5rem 1rem 1.5rem;
        }
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1.2rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-break: break-word;
        }
        .bot {
            background: #f1f3f6;
            align-self: flex-start;
        }
        .user {
            background: #6c63ff;
            color: #fff;
            align-self: flex-end;
        }
        .advice-bubble {
            background: #e6f7ef;
            color: #222;
            border: 1px solid #b2e2d3;
            font-size: 1.1rem;
            padding: 1.2rem 1.2rem 1.2rem 1.2rem;
            position: relative;
        }
        .advice-bubble p {
            margin-bottom: 0.7em;
        }
        .advice-divider {
            border-top: 1px solid #b2e2d3;
            margin: 1em 0 0.5em 0;
        }
        .advice-closing {
            color: #4a4a4a;
            font-style: italic;
            font-size: 1.05em;
            text-align: center;
            margin-top: 0.5em;
        }
        .restart-btn {
            display: block;
            margin: 1.5em auto 0 auto;
        }
    </style>
</head>
<body class="bg-light">
<div class="chat-container">
    <h3 class="text-center mb-4">Sleep Hygiene Chatbot</h3>
    <div id="chat-log" class="chat-log mb-3"></div>
    <form id="chat-form" autocomplete="off">
        <div class="input-group">
            <input type="text" id="user-input" class="form-control" placeholder="Type your answer..." required autofocus>
            <button class="btn btn-primary" type="submit">Send</button>
        </div>
    </form>
    <button id="restart-btn" class="btn btn-outline-secondary restart-btn" style="display:none;">Restart</button>
    <a href="/history" class="btn btn-link d-block mt-2 text-center">View My Advice History</a>
</div>
<script>
const questions = [
    "How many hours do you usually sleep per night?",
    "What time do you usually go to bed? (e.g., 22:30)",
    "What time do you usually wake up? (e.g., 06:30)",
    "Do you use screens (phone, TV, etc.) before bed? (yes/no)",
    "Do you consume caffeine after 6 PM? (yes/no)",
    "How often do you exercise? (daily/weekly/none)",
    "Do you have any current sleep difficulties? (optional)"
];
let answers = [];
let current = 0;

const chatLog = document.getElementById('chat-log');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');
const restartBtn = document.getElementById('restart-btn');

function addBubble(text, sender) {
    const div = document.createElement('div');
    div.className = 'chat-bubble ' + sender;
    div.innerText = text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function addAdviceBubble(advice) {
    // Remove bullet points and display each line as a paragraph
    let lines = advice.split(/\n|<br\s*\/?>(?=\s*[-â€¢\d])/g).filter(l => l.trim());
    if (lines.length < 2) {
        lines = advice.split('\n').filter(l => l.trim());
    }
    const div = document.createElement('div');
    div.className = 'chat-bubble advice-bubble bot';
    let html = '';
    for (let l of lines) {
        html += `<p>${l}</p>`;
    }
    div.innerHTML = html;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function askNext() {
    if (current < questions.length) {
        setTimeout(() => addBubble(questions[current], 'bot'), 400);
    } else {
        // All questions answered, send to backend
        addBubble('Thank you! Generating your personalized advice...', 'bot');
        fetch('/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({answers})
        })
        .then(res => res.json())
        .then(data => {
            addAdviceBubble(data.advice);
            chatForm.style.display = 'none';
            restartBtn.style.display = 'block';
        })
        .catch(() => addBubble('Sorry, something went wrong.', 'bot'));
    }
}

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const val = userInput.value.trim();
    if (!val) return;
    addBubble(val, 'user');
    answers.push(val);
    userInput.value = '';
    current++;
    askNext();
});

restartBtn.addEventListener('click', function() {
    chatLog.innerHTML = '';
    answers = [];
    current = 0;
    chatForm.style.display = 'block';
    restartBtn.style.display = 'none';
    userInput.value = '';
    askNext();
});

// Start the chat
window.onload = () => askNext();
</script>
</body>
</html> 